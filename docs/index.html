<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>OpenDartboard Debug Dashboard</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: #0d1117;
            color: #f0f6fc;
            line-height: 1.4;
        }
        
        .dashboard {
            display: grid;
            grid-template-columns: 300px 1fr;
            grid-template-rows: auto 1fr auto;
            height: 100vh;
            gap: 1rem;
            padding: 1rem;
        }
        
        .header {
            grid-column: 1 / -1;
            background: #21262d;
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid #30363d;
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .header-logo {
            width: 64px;
            height: 64px;
            border-radius: 8px;
        }
        
        .header-content {
            flex: 1;
        }
        
        .sidebar {
            background: #21262d;
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid #30363d;
            overflow-y: auto;
        }
        
        .main-content {
            background: #21262d;
            border-radius: 8px;
            border: 1px solid #30363d;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        /* Bottom Console */
        .bottom-console {
            grid-column: 1 / -1;
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 8px;
            height: 350px;
            display: flex;
            flex-direction: column;
        }
        
        .console-header {
            background: #161b22;
            padding: 0.5rem 1rem;
            border-bottom: 1px solid #30363d;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .console-title {
            color: #f0f6fc;
            font-size: 14px;
            font-weight: 600;
        }
        
        .console-logs {
            flex: 1;
            background: #0d1117;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 12px;
            padding: 0.5rem;
            overflow-y: auto;
        }
        
        .console-log-line {
            margin: 0.1rem 0;
            word-wrap: break-word;
        }
        
        .console-log-line.error { color: #f85149; }
        .console-log-line.warn { color: #d29922; }
        .console-log-line.info { color: #4ac26b; }
        .console-log-line.debug { color: #7d8590; }
        
        .tabs {
            display: flex;
            background: #161b22;
            border-bottom: 1px solid #30363d;
        }
        
        .tab {
            padding: 1rem 1.5rem;
            cursor: pointer;
            border: none;
            background: none;
            color: #7d8590;
            font-size: 14px;
            border-bottom: 3px solid transparent;
        }
        
        .tab.active {
            color: #f0f6fc;
            border-bottom-color: #1f6feb;
        }
        
        .tab-content {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Connection Panel */
        .connection-panel {
            margin-bottom: 2rem;
        }
        
        .connection-inputs {
            display: grid;
            grid-template-columns: 1fr 80px;
            gap: 0.5rem;
            margin: 0.5rem 0;
        }
        
        .connection-panel input {
            width: 100%;
            padding: 0.5rem;
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 4px;
            color: #f0f6fc;
        }
        
        .connection-help {
            font-size: 12px;
            color: #7d8590;
            margin: 0.25rem 0 0.75rem 0;
            line-height: 1.3;
        }
        
        .connection-help a {
            color: #1f6feb;
            text-decoration: none;
        }
        .connection-help a:hover {
            text-decoration: underline;
        }
        .connection-help a:visited {
            color: #1f6feb;
        }
        
        .connection-panel button {
            width: 100%;
            padding: 0.75rem;
            margin: 0.25rem 0;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
        }
        
        .connect-btn { background: #238636; color: white; }
        .disconnect-btn { background: #da3633; color: white; }
        
        .status {
            padding: 0.75rem;
            border-radius: 4px;
            margin: 1rem 0;
            font-weight: 500;
        }
        
        .status.connected { background: #1a2f1a; color: #4ac26b; border: 1px solid #2d5a2d; }
        .status.disconnected { background: #2f1a1a; color: #f85149; border: 1px solid #5a2d2d; }
        
        /* Score Display */
        .score-display {
            text-align: center;
            padding: 2rem;
            background: #161b22;
            border-radius: 8px;
            margin-bottom: 1rem;
        }
        
        .score-display .score {
            font-size: 3rem;
            font-weight: bold;
            color: #1f6feb;
        }
        
        /* Score History */
        .score-history {
            background: #161b22;
            border-radius: 8px;
            border: 1px solid #30363d;
            overflow-y: auto;
        }
        
        .score-history-header {
            padding: 1rem;
            border-bottom: 1px solid #30363d;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .score-history-title {
            color: #f0f6fc;
            font-size: 1rem;
            font-weight: 600;
        }
        
        .score-history-list {
            padding: 0.5rem;
        }
        
        .score-item {
            padding: 0.75rem;
            margin: 0.25rem 0;
            background: #21262d;
            border-radius: 4px;
            border-left: 3px solid #1f6feb;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 13px;
        }
        
        .score-item-main {
            color: #f0f6fc;
            font-weight: bold;
            margin-bottom: 0.25rem;
        }
        
        .score-item-details {
            color: #7d8590;
            font-size: 11px;
        }
        
        /* Debug Images Grid */
        .debug-highlight {
            background: #161b22;
            border-radius: 8px;
            padding: 1rem;
            border: 1px solid #30363d;
            margin-bottom: 1rem;
            text-align: center;
        }
        
        .debug-highlight img {
            width: 100%;
            max-width: 100%;
            height: auto;
            border-radius: 4px;
        }
        
        .debug-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }
        
        .debug-item {
            background: #161b22;
            border-radius: 8px;
            padding: 1rem;
            border: 1px solid #30363d;
        }
        
        .debug-item img {
            width: 100%;
            height: auto;
            border-radius: 4px;
        }
        
        /* Logs */
        .logs-container {
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 4px;
            height: 400px;
            overflow-y: auto;
            font-family: 'Monaco', monospace;
            font-size: 12px;
            padding: 1rem;
        }
        
        .log-line {
            margin: 0.25rem 0;
            word-break: break-all;
        }
        
        .log-line.error { color: #f85149; }
        .log-line.warn { color: #d29922; }
        .log-line.info { color: #4ac26b; }
        .log-line.debug { color: #7d8590; }
        
        /* Utility */
        .section-title {
            color: #f0f6fc;
            font-size: 1.2rem;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #30363d;
        }
        
        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        
        /* Live Streams Grid */
        .streams-grid {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            padding: 1rem 0;
        }
        
        .stream-item {
            background: #161b22;
            border-radius: 8px;
            padding: 1rem;
            border: 1px solid #30363d;
        }
        
        .stream-item h4 {
            color: #f0f6fc;
            margin-bottom: 0.5rem;
            font-size: 14px;
        }
        
        .stream-item img {
            width: 100%;
            height: auto;
            background: #000;
            display: block;
            border-radius: 4px;
            min-height: 200px;
        }
        
        /* Full-screen Image Modal */
        .image-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 9999;
            cursor: pointer;
        }
        
        .image-modal img {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            max-width: 95%;
            max-height: 95%;
            object-fit: contain;
        }
        
        .image-modal-close {
            position: absolute;
            top: 20px;
            right: 30px;
            color: #fff;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
            z-index: 10000;
        }
        
        .image-modal-close:hover {
            opacity: 0.7;
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <header class="header">
            <img class="header-logo" 
                 src="https://avatars.githubusercontent.com/u/213697851" 
                 alt="OpenDartboard Logo">
            <div class="header-content">
                <h1>OpenDartboard Debug Dashboard</h1>
                <p>Real-time monitoring and debugging interface</p>
            </div>
        </header>
        
        <aside class="sidebar">
            <!-- Connection Panel -->
            <div class="connection-panel">
                <h3 class="section-title">Connection</h3>
                <div id="connectionStatus" class="status disconnected">❌ Disconnected</div>
                
                <!-- Host and Port inputs -->
                <div style="display: grid; grid-template-columns: 1fr 80px; gap: 0.5rem; margin: 0.5rem 0 0.25rem 0;">
                    <label style="font-size: 12px; color: #7d8590; margin-bottom: -6px;">Host</label>
                    <label style="font-size: 12px; color: #7d8590; margin-bottom: -6px;">Port</label>
                </div>
                <div class="connection-inputs">
                    <input type="text" id="hostInput" placeholder="Host" value="localhost">
                    <input type="number" id="portInput" placeholder="Port" value="13520" min="1" max="65535">
                </div>
                
                <div class="connection-help">
                    If you are running the server remotely, you can connect using:
                    <a href="#" onclick="javascript:getElementById('hostInput').value='opendartboard.local';">opendartboard.local</a> or via a IP address <a href="#" onclick="javascript:getElementById('hostInput').value='192.168.x.x';">192.168.x.x</a>
                </div>
                
                <button id="connectBtn" class="connect-btn">Connect</button>
                <button id="disconnectBtn" class="disconnect-btn" style="display: none;">Disconnect</button>
            </div>
            
            <!-- Quick Stats -->
            <div id="quickStats">
                <h3 class="section-title">System Status</h3>
                <div id="healthStatus">Checking...</div>
                <div id="scoreCount">Scores: 0</div>
                <div id="logCount">Logs: 0</div>
            </div>
        </aside>
        
        <main class="main-content">
            <div class="tabs">
                <button class="tab active" data-tab="scores">Live Scores</button>
                <button class="tab" data-tab="streams">Live Streams</button>
                <button class="tab" data-tab="debug">Debug Images</button>
                <button class="tab" data-tab="config">Configuration</button>
                <button class="tab" data-tab="info">Project Info</button>
            </div>
            
            <!-- Live Scores Tab -->
            <div class="tab-content active" id="scores">
                 <h3 class="section-title">Live Scores</h3>
                <div class="score-display">
                    <div class="score" id="lastScore">Waiting...</div>
                    <div id="lastScoreDetails">Connect to start receiving scores</div>
                </div>
                
                <!-- Score History -->
                <div class="score-history">
                    <div class="score-history-header">
                        <div class="score-history-title">📊 Recent Scores</div>
                        <button onclick="clearScoreHistory()" style="padding: 0.25rem 0.75rem; background: #6f42c1; color: white; border: none; border-radius: 4px; font-size: 12px;">Clear</button>
                    </div>
                    <div class="score-history-list" id="scoreHistoryList">
                        <div style="padding: 1rem; text-align: center; color: #7d8590;">No scores yet. Connect to start receiving scores...</div>
                    </div>
                </div>
            </div>
            
            <!-- Live Streams Tab -->
            <div class="tab-content" id="streams">
                <h3 class="section-title">Live Video Streams</h3>
                <div class="streams-grid">
                    <div class="stream-item">
                        <h4>📹 Raw Camera Feeds</h4>
                        <img id="stream0" alt="Raw Camera Feed">
                        <h4>🎯 Motion Detection</h4>
                        <img id="stream1" alt="Motion Detection">
                         <h4>🔍 Motion Analysis</h4>
                        <img id="stream2" alt="Motion Analysis">
                        <h4>📊 Difference Stream</h4>
                        <img id="stream3" alt="Difference Stream">
                        <h4>⚡ Threshold Stream</h4>
                        <img id="stream4" alt="Threshold Stream">
                         <h4>🔗 Threshold Diff</h4>
                        <img id="stream5" alt="Threshold Diff">
                         <h4>📍 Tip Detection</h4>
                        <img id="stream6" alt="Tip Detection">
                        <h4>🎪 Points Overlay</h4>
                        <img id="stream7" alt="Points Overlay">
                    </div>
                </div>
            </div>
            
            <!-- Debug Images Tab -->
            <div class="tab-content" id="debug">
                <h3 class="section-title">Debug Images</h3>
                
                <!-- Calibration Summary Highlight -->
                <div class="debug-highlight" id="calibrationHighlight" style="display: none;">
                    <h4 style="margin-bottom: 1rem; color: #f0f6fc;">📐 Calibration Summary</h4>
                    <img id="calibrationSummaryImg" alt="Calibration Summary" onerror="this.parentElement.style.display='none'">
                </div>
                
                <div class="debug-grid" id="debugGrid">
                    <p>Connect to load debug images...</p>
                </div>
            </div>
            
            <!-- Configuration Tab -->
            <div class="tab-content" id="config">
                <h3 class="section-title">Configuration</h3>
                <pre id="configData" style="background: #0d1117; padding: 1rem; border-radius: 4px; border: 1px solid #30363d; overflow: auto;">Connect to load configuration...</pre>
            </div>
            
            <!-- Project Info Tab -->
            <div class="tab-content" id="info">
                <h3 class="section-title">Project Information</h3>
                <pre id="infoData" style="background: #0d1117; padding: 1rem; border-radius: 4px; border: 1px solid #30363d; overflow: auto;">Connect to load project info...</pre>
            </div>
        </main>
        
        <!-- Bottom Console -->
        <div class="bottom-console">
            <div class="console-header">
                <div class="console-title">🖥️ Live Console</div>
                <button onclick="clearConsole()" style="padding: 0.25rem 0.75rem; background: #6f42c1; color: white; border: none; border-radius: 4px; font-size: 12px;">Clear</button>
            </div>
            <div class="console-logs" id="consoleLogs">
                <div class="console-log-line info">Console ready. Connect to start receiving logs...</div>
            </div>
        </div>
    </div>

    <!-- Image Modal -->
    <div class="image-modal" id="imageModal" onclick="closeImageModal()">
        <span class="image-modal-close">&times;</span>
        <img id="modalImage" src="" alt="">
    </div>

    <script>
        // Dashboard state
        let currentHost = 'localhost:13520';
        let socket = null;
        let connected = false;
        let scoreCount = 0;
        let logCount = 0;
        let consolePollingInterval = null;
        let totalScoreCount = 0; // For score history numbering
        
        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            setupTabs();
            setupConnection();
            
            // Try to connect on load
            setTimeout(() => {
                document.getElementById('connectBtn').click();
            }, 500);
        });
        
        // Tab system
        function setupTabs() {
            const tabs = document.querySelectorAll('.tab');
            const contents = document.querySelectorAll('.tab-content');
            
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const targetId = tab.dataset.tab;
                    
                    // Update active states
                    tabs.forEach(t => t.classList.remove('active'));
                    contents.forEach(c => c.classList.remove('active'));
                    
                    tab.classList.add('active');
                    document.getElementById(targetId).classList.add('active');
                    
                    // Load content for specific tabs
                    if (connected) {
                        if (targetId === 'debug') {
                            loadDebugImages();
                        } else if (targetId === 'config') {
                            loadConfig();
                        } else if (targetId === 'info') {
                            loadInfo();
                        } else if (targetId === 'streams') {
                            startStreams();
                        }
                    }
                    
                    // Stop streams when switching away
                    if (targetId !== 'streams') {
                        stopStreams();
                    }
                });
            });
        }
        
        
        // updateCurrenthost 

        
        
        // Connection management
        function setupConnection() {
            const hostInput = document.getElementById('hostInput');
            const portInput = document.getElementById('portInput');
            const connectBtn = document.getElementById('connectBtn');
            const disconnectBtn = document.getElementById('disconnectBtn');
            
            connectBtn.addEventListener('click', connect);
            disconnectBtn.addEventListener('click', disconnect);
            
            // Update currentHost when inputs change
            function updateCurrentHost() {
                const host = hostInput.value || 'localhost';
                const port = portInput.value || '13520';
                currentHost = `${host}:${port}`;
            }
            
            hostInput.addEventListener('change', updateCurrentHost);
            portInput.addEventListener('change', updateCurrentHost);
            
            // Set initial value
            updateCurrentHost();
        }
        
        function connect() {
            if (connected) return;
            
            updateConnectionStatus('connecting', `Connecting to ${currentHost}...`);

            // Check health first
            checkHealth().then(healthy => {
                if (healthy) {
                    connectWebSocket();

                    updateConnectionStatus('connected', `✅ Connected to ${currentHost}`);
                    startConsolePolling();
                    
                    // Always load debug images for caching
                    loadDebugImages();
                    loadConfig();
                    loadInfo();
                    startStreams();    
                } else {
                    updateConnectionStatus('disconnected', `❌ Cannot reach ${currentHost}`);
                }
            });
        }
        
        function disconnect() {
            if (socket) {
                socket.close();
                socket = null;
            }
            if (consolePollingInterval) {
                clearInterval(consolePollingInterval);
                consolePollingInterval = null;
            }
            
            // Stop streams on disconnect
            stopStreams();
            
            connected = false;
            updateConnectionStatus('disconnected', '❌ Disconnected');
            
            // Reset health status when disconnecting
            document.getElementById('healthStatus').textContent = '❌ Disconnected';
        }
        
        function updateConnectionStatus(state, message) {
            const status = document.getElementById('connectionStatus');
            const connectBtn = document.getElementById('connectBtn');
            const disconnectBtn = document.getElementById('disconnectBtn');
            
            status.className = `status ${state}`;
            status.textContent = message;
            connected = (state === 'connected');
            
            // Show/hide buttons based on connection state
            if (connected) {
                connectBtn.style.display = 'none';
                disconnectBtn.style.display = 'block';
            } else {
                connectBtn.style.display = 'block';
                disconnectBtn.style.display = 'none';
            }
        }
        
        // Health check
        async function checkHealth() {
            try {
                const response = await fetch(`http://${currentHost}/health`);
                const data = await response.json();
                
                document.getElementById('healthStatus').textContent = `✅ ${data.service || 'Healthy'}`;
                return true;
            } catch (error) {
                document.getElementById('healthStatus').textContent = '❌ Unreachable';
                return false;
            }
        }
        
        // WebSocket connection
        function connectWebSocket() {
            socket = new WebSocket(`ws://${currentHost}/scores`);
            
            socket.onopen = () => {
                updateConnectionStatus('connected', `✅ Connected to ${currentHost}`);
                updateQuickStats();
            };
            
            socket.onmessage = (event) => {
                try {
                    const scoreData = JSON.parse(event.data);
                    handleNewScore(scoreData);
                } catch (error) {
                    console.error('Error parsing score:', error);
                }
            };
            
            socket.onclose = () => {
                updateConnectionStatus('disconnected', '❌ Connection lost');
                document.getElementById('healthStatus').textContent = '❌ Connection lost';
                connected = false;
            };
            
            socket.onerror = (error) => {
                updateConnectionStatus('disconnected', `❌ Connection error`);
                console.error('WebSocket error:', error);
            };
        }
        
        // Score handling
        function handleNewScore(scoreData) {
            scoreCount++;
            totalScoreCount++;
            
            // Update main display
            document.getElementById('lastScore').textContent = scoreData.score;
            document.getElementById('lastScoreDetails').innerHTML = `
                Position: (${scoreData.position.x}, ${scoreData.position.y}) | 
                Confidence: ${(scoreData.confidence * 100).toFixed(1)}% | 
                Camera: ${scoreData.camera} | 
                ${new Date(scoreData.timestamp).toLocaleTimeString()}
            `;
            
            // Add to score history
            addScoreToHistory(scoreData);
            
            updateQuickStats();
        }
        
        // Score history functions
        function addScoreToHistory(scoreData) {
            const historyList = document.getElementById('scoreHistoryList');
            
            // Clear placeholder text if this is first score
            if (totalScoreCount === 1) {
                historyList.innerHTML = '';
            }
            
            const item = document.createElement('div');
            item.className = 'score-item';
            
            const time = new Date(scoreData.timestamp).toLocaleTimeString();
            item.innerHTML = `
                <div class="score-item-main">#${totalScoreCount} - ${scoreData.score}</div>
                <div class="score-item-details">
                    Position: (${scoreData.position.x}, ${scoreData.position.y}) | 
                    Confidence: ${(scoreData.confidence * 100).toFixed(1)}% | 
                    Camera: ${scoreData.camera} | 
                    ${scoreData.processing_time_ms}ms | 
                    ${time}
                </div>
            `;
            
            // Add to top of list
            historyList.insertBefore(item, historyList.firstChild);
            
            // Keep only last 20 scores
            while (historyList.children.length > 20) {
                historyList.removeChild(historyList.lastChild);
            }
        }
        
        function clearScoreHistory() {
            const historyList = document.getElementById('scoreHistoryList');
            historyList.innerHTML = '<div style="padding: 1rem; text-align: center; color: #7d8590;">Score history cleared...</div>';
            totalScoreCount = 0;
        }
        
        // Bottom Console Polling
        function startConsolePolling() {
            if (consolePollingInterval) {
                clearInterval(consolePollingInterval);
            }
            
            loadConsoleLogs();
            consolePollingInterval = setInterval(() => {
                if (connected) {
                    loadConsoleLogs();
                }
            }, 2000);
        }
        
        async function loadConsoleLogs() {
            try {
                const response = await fetch(`http://${currentHost}/debug/logs`);
                const logs = await response.json();
                
                const container = document.getElementById('consoleLogs');
                container.innerHTML = '';
                
                logs.forEach(log => {
                    const div = document.createElement('div');
                    div.className = 'console-log-line';
                    
                    // Color coding based on log level
                    if (log.includes('[ERROR]')) div.classList.add('error');
                    else if (log.includes('[WARN]')) div.classList.add('warn');
                    else if (log.includes('[INFO]')) div.classList.add('info');
                    else if (log.includes('[DEBUG]')) div.classList.add('debug');
                    
                    div.textContent = log;
                    container.appendChild(div);
                });
                
                // Scroll to bottom
                container.scrollTop = container.scrollHeight;
                
            } catch (error) {
                console.error('Error loading console logs:', error);
            }
        }
        
        function clearConsole() {
            document.getElementById('consoleLogs').innerHTML = '';
        }
        
        // Configuration
        async function loadConfig() {
            console.log('Loading configuration...', connected);

            if (!connected) {
                document.getElementById('configData').textContent = 'Not connected. Please connect first.';
                return;
            }
            
            try {
                document.getElementById('configData').textContent = 'Loading configuration...';
                
                const response = await fetch(`http://${currentHost}/config`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const config = await response.json();
                document.getElementById('configData').textContent = JSON.stringify(config, null, 2);
            } catch (error) {
                console.error('Error loading configuration:', error);
                document.getElementById('configData').textContent = `Error loading configuration: ${error.message}`;
            }
        }
        
        // Project info
        async function loadInfo() {
            if (!connected) {
                document.getElementById('infoData').textContent = 'Not connected. Please connect first.';
                return;
            }
            
            try {
                document.getElementById('infoData').textContent = 'Loading project info...';
                
                const response = await fetch(`http://${currentHost}/info`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const info = await response.json();
                document.getElementById('infoData').textContent = JSON.stringify(info, null, 2);
            } catch (error) {
                console.error('Error loading project info:', error);
                document.getElementById('infoData').textContent = `Error loading project info: ${error.message}`;
            }
        }
        
        // Image modal functions
        function openImageModal(imageSrc) {
            const modal = document.getElementById('imageModal');
            const modalImg = document.getElementById('modalImage');
            modal.style.display = 'block';
            modalImg.src = imageSrc;
        }
        
        function closeImageModal() {
            document.getElementById('imageModal').style.display = 'none';
        }
        
        // Close modal on Escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeImageModal();
            }
        });
        
        // Debug images
        async function loadDebugImages() {
            if (!connected) {
                document.getElementById('debugGrid').innerHTML = '<p>Not connected. Please connect first.</p>';
                const img = document.getElementById('calibrationSummaryImg');
                img.src = '';
                img.style.display = 'none';
                return;
            }
            
            try {
                document.getElementById('debugGrid').innerHTML = '<p>Loading debug images...</p>';
                
                const response = await fetch(`http://${currentHost}/debug/list`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const files = await response.json();
                
                const grid = document.getElementById('debugGrid');
                grid.innerHTML = '';
                
                // Check for calibration summary and show as highlight
                const calibrationSummary = 'calibration_summary_all_cameras.jpg';
                if (files.includes(calibrationSummary)) {
                    const highlight = document.getElementById('calibrationHighlight');
                    const img = document.getElementById('calibrationSummaryImg');
                    img.src = `http://${currentHost}/debug/${calibrationSummary}`;
                    highlight.style.display = 'block';
                }
                
                // Show other images in grid (excluding the highlight image)
                const otherFiles = files.filter(file => file !== calibrationSummary);
                
                if (otherFiles.length === 0) {
                    grid.innerHTML = '<p>No debug images found</p>';
                    return;
                }
                
                otherFiles.forEach(file => {
                    const div = document.createElement('div');
                    div.className = 'debug-item';
                    div.innerHTML = `
                        <h4>${file}</h4>
                        <img src="http://${currentHost}/debug/${file}" alt="${file}" 
                             onclick="openImageModal('http://${currentHost}/debug/${file}')"
                             style="cursor: pointer;"
                             onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                        <p style="display: none; color: #f85149; text-align: center; padding: 1rem;">Failed to load image</p>
                    `;
                    grid.appendChild(div);
                });
                
                // Make calibration summary clickable too
                const calibrationImg = document.getElementById('calibrationSummaryImg');
                if (calibrationImg) {
                    calibrationImg.style.cursor = 'pointer';
                    calibrationImg.onclick = () => openImageModal(calibrationImg.src);
                }
                
            } catch (error) {
                console.error('Error loading debug images:', error);
                document.getElementById('debugGrid').innerHTML = `<p style="color: #f85149;">Error loading debug images: ${error.message}</p>`;
                // Hide highlight on error
                document.getElementById('calibrationHighlight').style.display = 'none';
            }
        }
        
        // Stream URLs configuration
        let streamUrls = [];
        
        let streamIntervals = [];
        
        // Stream management
        function startStreams() {
            if (!connected) return;
            
            // Stop any existing streams
            stopStreams();
            
            // Get current host without port for streams
            const host = document.getElementById('hostInput').value || 'localhost';
            
            // Generate stream URLs with current host
            streamUrls = [
                `http://${host}:8081/`, // raw
                `http://${host}:8082/`, // motion 
                `http://${host}:8083/`, // motion2
                `http://${host}:8084/`, // dif stream (1fps)
                `http://${host}:8085/`, // tresh stream (1fps)
                `http://${host}:8086/`, // tresh diff stream (1fps)
                `http://${host}:8087/`, // tip stream (1fps)
                `http://${host}:8088/`, // points on screen stream (1fps)
            ];
            
            // Start all streams
            streamUrls.forEach((url, index) => {
                connectStream(index, url);
            });
        }
        
        function stopStreams() {
            // Clear all stream intervals
            streamIntervals.forEach(interval => {
                if (interval) clearTimeout(interval);
            });
            streamIntervals = [];
        }
        
        function connectStream(idx, url) {
            const img = document.getElementById("stream" + idx);
            if (!img) return;
            
            const stamp = Date.now(); // cache-buster
            img.src = url + "?t=" + stamp;
            
            // Make stream images clickable for full-screen view
            img.style.cursor = 'pointer';
            img.onclick = () => openImageModal(img.src);
            
            // Schedule next refresh (1 second for real-time feel)
            const interval = setTimeout(() => connectStream(idx, url), 1000);
            streamIntervals[idx] = interval;
        }
    </script>
</body>
</html>